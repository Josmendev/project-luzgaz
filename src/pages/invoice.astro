---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Solicitar Estudio - LUZGAS Asesoría Energética" description="Solicita tu estudio energético gratuito con LUZGAS. Descubre cuánto puedes ahorrar en tu factura energética.">
	<Header />
	<main class="pt-16">
		<!-- Sección de Solicitar Estudio Gratuito -->
		<section
		  class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 via-white to-luzgas-green/10 relative overflow-hidden scroll-animate"
		  data-animate="fade-up"
		>
		  <!-- Background Elements -->
		  <div class="absolute inset-0 opacity-5">
		    <div class="absolute top-20 left-10 w-32 h-32 bg-luzgas-green rounded-full"></div>
		    <div class="absolute bottom-20 right-20 w-24 h-24 bg-luzgas-blue rounded-full"></div>
		    <div class="absolute top-40 right-32 w-16 h-16 bg-luzgas-yellow rounded-full"></div>
		    <div class="absolute bottom-40 left-20 w-20 h-20 bg-luzgas-green rounded-full"></div>
		  </div>

		  <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full flex flex-col items-center">
		    <!-- Header Section -->
		    <div class="text-center mb-16">
		      <h1 class="text-3xl md:text-5xl font-bold text-gray-800 mb-2 md:mb-3">
		        Solicita tu <span class="text-luzgas-green">Estudio Gratuito</span>
		      </h1>
		      <p class="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
		        Descubre cuánto puedes ahorrar en tu factura energética con nuestro análisis profesional sin costo
		      </p>
		    </div>

		    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 items-start w-full">
		      <!-- Información y Beneficios -->
		      <div class="lg:col-span-1 space-y-4 scroll-animate" data-animate="fade-right">
		        <!-- Estadística Principal -->
		        <div class="bg-gradient-to-br from-luzgas-green to-green-600 rounded-2xl p-6 shadow-xl text-center hover:shadow-2xl hover:scale-105 transition-all duration-300 group">
		          <div class="text-4xl font-bold text-luzgas-yellow mb-2 group-hover:scale-110 transition-transform duration-300">99%</div>
		          <p class="text-lg text-white font-semibold mb-1">de nuestros clientes</p>
		          <p class="text-sm text-white/90">obtienen ahorros significativos</p>
		        </div>

		        <!-- Beneficios -->
		        <div class="bg-white rounded-2xl p-6 shadow-xl border border-gray-200 hover:shadow-2xl hover:scale-105 transition-all duration-300">
		          <h4 class="text-lg font-bold text-gray-800 mb-4 text-center">¿Qué incluye tu estudio?</h4>
		          <div class="space-y-3">
		            <div class="flex items-center space-x-3">
		              <div class="w-8 h-8 bg-gradient-to-br from-luzgas-green to-green-600 rounded-lg flex items-center justify-center flex-shrink-0">
		                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
		                </svg>
		              </div>
		              <div>
		                <p class="text-gray-800 font-semibold text-sm">Análisis detallado</p>
		                <p class="text-gray-600 text-xs">Patrones de uso energético</p>
		              </div>
		            </div>
		            <div class="flex items-center space-x-3">
		              <div class="w-8 h-8 bg-gradient-to-br from-luzgas-blue to-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
		                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
		                </svg>
		              </div>
		              <div>
		                <p class="text-gray-800 font-semibold text-sm">Cálculo de ahorros</p>
		                <p class="text-gray-600 text-xs">Potencial anual de ahorro</p>
		              </div>
		            </div>
		            <div class="flex items-center space-x-3">
		              <div class="w-8 h-8 bg-gradient-to-br from-luzgas-yellow to-orange-400 rounded-lg flex items-center justify-center flex-shrink-0">
		                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
		                </svg>
		              </div>
		              <div>
		                <p class="text-gray-800 font-semibold text-sm">Recomendaciones</p>
		                <p class="text-gray-600 text-xs">Soluciones personalizadas</p>
		              </div>
		            </div>
		          </div>
		        </div>

		        <!-- Garantías -->
		        <div class="grid grid-cols-2 gap-3">
		          <div class="bg-white rounded-lg p-3 text-center shadow-lg border border-gray-200 hover:shadow-xl hover:scale-105 transition-all duration-300 group">
		            <svg class="w-6 h-6 text-luzgas-green mx-auto mb-1 group-hover:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
		            </svg>
		            <p class="text-gray-800 font-semibold text-xs">100% Gratuito</p>
		            <p class="text-gray-600 text-xs">Sin compromiso</p>
		          </div>
		          <div class="bg-white rounded-lg p-3 text-center shadow-lg border border-gray-200 hover:shadow-xl hover:scale-105 transition-all duration-300 group">
		            <svg class="w-6 h-6 text-luzgas-blue mx-auto mb-1 group-hover:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
		            </svg>
		            <p class="text-gray-800 font-semibold text-xs">Respuesta 24h</p>
		            <p class="text-gray-600 text-xs">Análisis rápido</p>
		          </div>
		        </div>
		      </div>

		      <!-- Formulario Moderno -->
		      <div class="lg:col-span-3 bg-white/95 backdrop-blur-sm rounded-3xl p-6 shadow-2xl border border-white/20 scroll-animate" data-animate="fade-left">
		        <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">Analizamos tus facturas de forma gratuita</h3>

		        <form id="invoice-form" class="space-y-4 mt-5">
		          <!-- Layout en dos columnas -->
		          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
		            <!-- Columna Izquierda -->
		            <div class="space-y-4">
		              <!-- Tipo de Cliente (horizontal en una columna) -->
		              <div>
		                <label class="block text-xs font-medium text-gray-700 mb-1">Tipo de cliente *</label>
		                <div class="grid grid-cols-2 gap-2">
		                  <label class="relative">
		                    <input type="radio" name="tipo_cliente" value="particular" class="sr-only" required>
		                    <div class="bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2.5 cursor-pointer transition-all duration-200 hover:border-luzgas-green hover:scale-105 hover:shadow-md">
		                      <div class="flex items-center justify-center space-x-2">
		                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
		                        </svg>
		                        <span class="font-semibold text-gray-800 text-sm">Particular</span>
		                      </div>
		                    </div>
		                  </label>
		                  <label class="relative">
		                    <input type="radio" name="tipo_cliente" value="empresa" class="sr-only" required>
		                    <div class="bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2.5 cursor-pointer transition-all duration-200 hover:border-luzgas-green hover:scale-105 hover:shadow-md">
		                      <div class="flex items-center justify-center space-x-2">
		                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
		                        </svg>
		                        <span class="font-semibold text-gray-800 text-sm">Empresa</span>
		                      </div>
		                    </div>
		                  </label>
		                </div>
		              </div>

		              <!-- Email -->
		              <div>
		                <label for="email_estudio" class="block text-xs font-medium text-gray-700 mb-1">Email *</label>
		                <input type="email" id="email_estudio" name="email" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-luzgas-green focus:border-transparent transition-all duration-200 text-sm hover:shadow-md">
		              </div>

		              <!-- Subida de Facturas -->
		              <div>
		                <label class="block text-xs font-medium text-gray-700 mb-1">Sube tu factura energética *</label>
		                <input type="file" id="file-input" name="factura" accept=".pdf,.jpg,.jpeg,.png,.gif" required class="hidden">
		                <div id="drop-zone" class="border-2 border-dashed border-luzgas-green/30 rounded-xl p-8 text-center hover:border-luzgas-green hover:bg-luzgas-green/5 transition-all duration-300 cursor-pointer group min-h-[120px] flex flex-col justify-center">
		                  <div class="w-10 h-10 bg-gradient-to-br from-luzgas-green to-green-600 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:scale-110 transition-transform duration-300">
		                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
		                    </svg>
		                  </div>
		                  <div class="space-y-1">
		                    <p class="text-sm font-bold text-gray-800">Arrastra tu factura aquí</p>
		                    <p class="text-xs text-gray-600">o <span class="text-luzgas-green font-semibold underline">haz clic para seleccionar</span></p>
		                    <p class="text-xs text-gray-500">PDF, JPG, PNG, GIF • Máximo: 800MB</p>
		                  </div>
		                </div>
		              </div>
		            </div>

		            <!-- Columna Derecha -->
		            <div class="space-y-4">
		              <!-- Nombre -->
		              <div>
		                <label for="nombre_estudio" class="block text-xs font-medium text-gray-700 mb-1">Nombre *</label>
		                <input type="text" id="nombre_estudio" name="nombre" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-luzgas-green focus:border-transparent transition-all duration-200 text-sm hover:shadow-md">
		              </div>

		              <!-- Teléfono -->
		              <div>
		                <label for="telefono_estudio" class="block text-xs font-medium text-gray-700 mb-1">Teléfono *</label>
		                <input type="tel" id="telefono_estudio" name="telefono" required class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-luzgas-green focus:border-transparent transition-all duration-200 text-sm hover:shadow-md">
		              </div>

		              <!-- Comentarios Adicionales -->
		              <div>
		                <label for="comentarios" class="block text-xs font-medium text-gray-700 mb-1">Mensaje adicional (opcional)</label>
		                <textarea id="comentarios" name="comentarios" rows="4" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-luzgas-green focus:border-transparent transition-all duration-200 resize-none text-sm hover:shadow-md" placeholder="Cuéntanos más detalles sobre tu consumo energético..."></textarea>
		              </div>
		            </div>
		          </div>

		          <!-- Checkbox de Privacidad -->
		          <div class="flex items-start space-x-2">
		            <input type="checkbox" id="privacidad_estudio" name="privacidad" required class="mt-1 w-4 h-4 text-luzgas-green border-gray-300 rounded focus:ring-luzgas-green">
		            <label for="privacidad_estudio" class="text-xs text-gray-600 leading-relaxed">
		              Acepto la <a href="#" class="text-luzgas-green hover:underline font-medium">política de privacidad</a> y autorizo el tratamiento de mis datos para recibir el estudio energético gratuito. *
		            </label>
		          </div>

		          <!-- Botón de Envío -->
		          <button type="submit" class="w-full bg-gradient-to-r from-luzgas-green to-luzgas-blue text-white px-8 py-4 rounded-lg font-semibold text-lg hover:shadow-xl hover:shadow-luzgas-green/30 transform hover:scale-[1.02] transition-all duration-300 flex items-center justify-center space-x-2 group">
		            <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
		              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
		            </svg>
		            <span>Envía y ahorra</span>
		          </button>
		        </form>
				</div>
			</div>
		</section>
	</main>
	<Footer />
</Layout>


<script>
	// Estados visuales para radio buttons
	function initRadioButtons() {
		const radioButtons = document.querySelectorAll('input[name="tipo_cliente"]');
		radioButtons.forEach(radio => {
			radio.addEventListener('change', function(this: HTMLInputElement) {
				radioButtons.forEach(r => {
					const container = r.closest('label')?.querySelector('div') as HTMLElement;
					if (container) {
						container.classList.remove('border-luzgas-green', 'bg-luzgas-green/10');
						container.classList.add('border-gray-200', 'bg-gray-50');
					}
				});

				if (this.checked) {
					const container = this.closest('label')?.querySelector('div') as HTMLElement;
					if (container) {
						container.classList.remove('border-gray-200', 'bg-gray-50');
						container.classList.add('border-luzgas-green', 'bg-luzgas-green/10');
					}
				}
			});
		});
	}

	// Funcionalidad drag & drop para archivos
	function initFileUpload() {
		const dropZone = document.getElementById('drop-zone');
		const fileInput = document.getElementById('file-input');
		let selectedFile = null;

		// Prevenir comportamiento por defecto
		['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
			dropZone?.addEventListener(eventName, preventDefaults, false);
		});

		function preventDefaults(e: any) {
			e.preventDefault();
			e.stopPropagation();
		}

		// Efectos visuales al arrastrar
		['dragenter', 'dragover'].forEach(eventName => {
			dropZone?.addEventListener(eventName, highlight, false);
		});

		['dragleave', 'drop'].forEach(eventName => {
			dropZone?.addEventListener(eventName, unhighlight, false);
		});

		function highlight() {
			dropZone?.classList.add('border-luzgas-green', 'bg-luzgas-green/10');
		}

		function unhighlight() {
			dropZone?.classList.remove('border-luzgas-green', 'bg-luzgas-green/10');
		}

		// Manejar drop
		dropZone?.addEventListener('drop', handleDrop, false);

		function handleDrop(e: any) {
			const dt = e.dataTransfer;
			const files = dt.files;
			handleFiles(files);
		}

		// Click para seleccionar archivo
		dropZone?.addEventListener('click', () => fileInput?.click());

		// Cambio en input file
		fileInput?.addEventListener('change', function(this: HTMLInputElement) {
			if (this.files) {
				handleFiles(this.files);
			}
		});

		function handleFiles(files: any) {
			if (files.length > 0) {
				const file = files[0];

				// Validar tipo de archivo
				const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
				if (!allowedTypes.includes(file.type)) {
					window.toast.show({
						message: 'Por favor, sube solo archivos PDF, JPG, PNG o GIF.',
						type: 'warning',
						duration: 4000
					});
					return;
				}

				// Validar tamaño (800MB)
				const maxSize = 800 * 1024 * 1024;
				if (file.size > maxSize) {
					window.toast.show({
						message: 'El archivo es demasiado grande. Máximo 800MB.',
						type: 'warning',
						duration: 4000
					});
					return;
				}

				selectedFile = file;
				updateDropZoneUI(file);
			}
		}

		function updateDropZoneUI(file: any) {
			const dropZone = document.getElementById('drop-zone');
			dropZone!.innerHTML = `
				<div class="w-10 h-10 bg-gradient-to-br from-luzgas-green to-green-600 rounded-full flex items-center justify-center mx-auto mb-2">
					<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
					</svg>
				</div>
				<div class="space-y-1">
					<p class="text-sm font-bold text-luzgas-green">Archivo seleccionado</p>
					<p class="text-xs text-gray-600">${file.name}</p>
					<p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
					<button type="button" onclick="resetFileUpload()" class="text-xs text-luzgas-green hover:underline font-semibold">Cambiar archivo</button>
				</div>
			`;
		}

		// Función global para resetear
		(window as any).resetFileUpload = function() {
			selectedFile = null;
			(fileInput as HTMLInputElement).value = '';
			dropZone!.innerHTML = `
				<div class="w-10 h-10 bg-gradient-to-br from-luzgas-green to-green-600 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:scale-110 transition-transform duration-300">
					<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
					</svg>
				</div>
				<div class="space-y-1">
					<p class="text-sm font-bold text-gray-800">Arrastra tu factura aquí</p>
					<p class="text-xs text-gray-600">o <span class="text-luzgas-green font-semibold underline">haz clic para seleccionar</span></p>
					<p class="text-xs text-gray-500">PDF, JPG, PNG, GIF • Máximo: 800MB</p>
				</div>
			`;
		};
	}

	// Manejo del formulario
	function initFormSubmission() {
		const form = document.getElementById('invoice-form') as HTMLFormElement;

		form?.addEventListener('submit', async function(e) {
			e.preventDefault();

			// Mostrar loading en el botón
			const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
			const originalContent = submitButton?.innerHTML || '';
			if (submitButton) {
				submitButton.innerHTML = `
					<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
						<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
						<path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
					</svg>
					<span>Enviando...</span>
				`;
				submitButton.disabled = true;
			}

			try {
				// Recopilar datos del formulario
				const formData = new FormData(form);
				const data = Object.fromEntries(formData.entries());

				// Validar que se haya seleccionado archivo
				const fileInput = document.getElementById('file-input') as HTMLInputElement;
				if (!fileInput?.files?.[0]) {
					throw new Error('Por favor, sube tu factura energética.');
				}

				const file = fileInput.files[0];

				// Preparar datos para EmailJS
				const emailParams = {
					to_email: 'josmendev@gmail.com',
					from_name: data.nombre,
					from_email: data.email,
					phone: data.telefono,
					client_type: data.tipo_cliente,
					message: data.comentarios || 'Sin comentarios adicionales',
					file_name: file.name,
					file_size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
					date: new Date().toLocaleDateString('es-ES'),
					time: new Date().toLocaleTimeString('es-ES')
				};

				// Preparar FormData para enviar archivo + datos
				const formDataToSend = new FormData();

				// Agregar datos del formulario
				Object.keys(data).forEach(key => {
					formDataToSend.append(key, data[key] as string);
				});

				// Agregar archivo
				formDataToSend.append('factura', file);

				// Enviar datos al API endpoint
				const response = await fetch('/api/send-email', {
					method: 'POST',
					body: formDataToSend // Enviar FormData en lugar de JSON
				});

				const result = await response.json();

				if (!response.ok || !result.success) {
					throw new Error(result.message || 'Error al enviar el email');
				}

				// Mostrar mensaje de éxito
				window.toast.show({
					message: '¡Solicitud enviada con éxito! Hemos recibido tu información y nos pondremos en contacto contigo. Recibirás tu estudio energético gratuito en las próximas 24 horas.',
					type: 'success',
					duration: 6000
				});

				// Resetear formulario
				form.reset();
				(window as any).resetFileUpload();

				// Resetear radio buttons
				const radioButtons = document.querySelectorAll('input[name="tipo_cliente"]');
				radioButtons.forEach(r => {
					const container = r.closest('label')?.querySelector('div') as HTMLElement;
					if (container) {
						container.classList.remove('border-luzgas-green', 'bg-luzgas-green/10');
						container.classList.add('border-gray-200', 'bg-gray-50');
					}
				});

			} catch (error) {
				const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
				window.toast.show({
					message: 'Error: ' + errorMessage,
					type: 'error',
					duration: 6000
				});
			} finally {
				// Restaurar botón
				if (submitButton) {
					submitButton.innerHTML = originalContent;
					submitButton.disabled = false;
				}
			}
		});
	}


	// Inicializar todo cuando el DOM esté listo
	document.addEventListener('DOMContentLoaded', function() {
		initRadioButtons();
		initFileUpload();
		initFormSubmission();
	});
</script>